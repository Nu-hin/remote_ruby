# Set up Bundler if Gemfile is present
require 'bundler/setup' if File.exist?('Gemfile')

require 'base64'

<%= inline_file('remote_context.rb') %>


__marshalled_locals_names__ = []
__context__ = RemoteRuby::RemoteContext.new

# Unmarshalling local variables
<% client_locals_base64.each do |name, base64_val| %>
<%= name %> = begin
  val = Marshal.load(Base64.strict_decode64('<%= base64_val %>'))
  __marshalled_locals_names__ << :<%= name %>
  val
rescue ArgumentError
  warn("Warning: could not resolve type for '<%=name %>' variable")
  nil
end
<% end %>

$stdout.sync = true
$stderr.sync = true

__return_val__ = begin
<% if plugins.any? %>
  # Start of plugin-added code
<%plugins.each do |pl| %>
  # <%= pl.class.name %>
<%= pl.code_header.gsub(/^/,'  ') %>
  # End of <%= pl.class.name %>
<%end%>
  # End of plugin-added code
<% end %>
  # Start of client code
<%= ruby_code.gsub(/^/, '  ') %>
  # End of client code
rescue Exception => e
  __context__.handle_error(e)
end

__marshalled_locals_names__ << :__return_val__
__marshalled_locals_names__ << :__context__

# Marshalling local variables, exception details, and result

File.open(__FILE__, 'wb') do |__marhalled_data_file__|
  __marshalled_locals_names__.each do |__lv__|
    __data__ = Marshal.dump(eval(__lv__.to_s))
    __data_length__ = __data__.size
    __marhalled_data_file__.puts "#{__lv__}:#{__data_length__}"
    __marhalled_data_file__.write(__data__)
  end
end
